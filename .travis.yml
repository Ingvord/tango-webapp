dist: trusty
language: java
sudo: false
env:
  - DOCKER_IMAGE_NAME=tangocs/waltz REGISTRY_USER=ingvord
services:
  - docker
addons:
  sonarcloud:
    organization: "tango-controls" # the key of the org you chose at step #3
    token:
      secure: $SONAR_TOKEN
script:
  - chmod 777 ./jmvcc
  - ./jmvcc jmvc/assemble
  - test -e build/distributions/waltz.war
after_success:
  - git fetch --unshallow --quiet
  - sonar-scanner -Dsonar.projectKey=org.tango-controls:TangoWebapp -Dsonar.sources=. -Dsonar.exclusions=build/**,jmvc/**,docs/**,apps/**
before_deploy:
  - docker build --pull --tag "$DOCKER_IMAGE_NAME" .
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
  - docker tag "$DOCKER_IMAGE_NAME" "${DOCKER_IMAGE_NAME}:${TRAVIS_BRANCH}"
deploy:
  - provider: script
    script: docker_push.sh latest
    on:
      branch: master
  - provider: script
    script: docker_push.sh $TRAVIS_TAG
    on:
      tags: true
  - provider: releases
    prerelease: true
    api_key: $GITHUB_OAUTH_TOKEN
    file: "build/distributions/waltz.war"
    skip_cleanup: true
    on:
      tags: true
  - provider: script
    script: bash .travis/deploy.sh
    skip_cleanup: true
    on:
      all_branches: true
jdk:
  - openjdk8
cache:
  directories:
    - '$HOME/.m2/repository'
